AWSTemplateFormatVersion: 2010-09-09
Description: https://venafi-ecosystem.s3.amazonaws.com/tlspk/cfn-tlspk-cluster-bootstrapper.yaml

Parameters:
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
  InstanceType:
    Type: String
    Default: m5.large
    AllowedValues:
      - t2.micro
      - m5.large
  TLSPKSAUserId:
    Type: String
  TLSPKSAUserSecret:
    Type: String
    NoEcho: true
Resources:
  Jumpbox:
    Type: AWS::EC2::Instance
    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: "PT10M"
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: !Ref InstanceType
      IamInstanceProfile: AmazonSSMRoleForInstancesQuickSetup
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 30
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash
            su ec2-user << EOF
              cd
              export TLSPK_SA_USER_ID=${TLSPKSAUserId}
              export TLSPK_SA_USER_SECRET='${TLSPKSAUserSecret}'
              curl -fsSL -o tlspk-helper.sh https://venafi-ecosystem.s3.amazonaws.com/tlspk/tlspk-helper.sh && chmod 700 tlspk-helper.sh
              
              ./tlspk-helper.sh install-tools              --auto-approve
              ./tlspk-helper.sh create-local-k8s-cluster   --auto-approve
              ./tlspk-helper.sh create-unsafe-tls-secrets  --auto-approve
              ./tlspk-helper.sh deploy-agent               --auto-approve
              ./tlspk-helper.sh install-operator           --auto-approve
              ./tlspk-helper.sh deploy-operator-components --auto-approve
              ./tlspk-helper.sh create-self-signed-issuer  --auto-approve
              ./tlspk-helper.sh create-safe-tls-secrets    --auto-approve

              /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource Jumpbox --region ${AWS::Region}
            EOF
      Tags:
        - Key: Name
          Value: !Join ["-", [!Ref AWS::StackName, !Ref AWS::Region]]

Outputs:
  JumpboxInstanceId:
    Value: !Ref Jumpbox
    Description: ID of the publicly accessible EC2 instance
